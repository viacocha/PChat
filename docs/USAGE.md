# PChat 使用说明

## 🚀 快速开始

### 步骤 1: 启动注册服务器（守护进程）

首先启动注册服务器，用于管理在线用户：

```bash
./bin/registryd
```

或者指定端口：

```bash
./bin/registryd -port 8888
```

服务器会显示：
```
🚀 启动注册服务器，端口: 8888
✅ 注册服务器已启动，监听端口 8888
```

## 界面模式

PChat 支持两种界面模式：

### CLI 模式（默认）
命令行界面，适合脚本和自动化场景。

```bash
./bin/pchat -port 9001 -registry 127.0.0.1:8888 -username Alice
```

### UI 模式
图形化界面，提供更好的用户体验。

```bash
./bin/pchat -port 9001 -registry 127.0.0.1:8888 -username Alice -ui true
```

**UI模式特性：**
- 📊 实时用户列表显示
- 💬 消息历史记录
- 📈 连接状态可视化
- ⏰ 实时时间显示
- 🎨 美观的界面布局

## 在同一台机器上运行两个实例

### 步骤 2: 启动第一个客户端

有两种方式设置用户名：

**方式 1：通过命令行参数（推荐）**
```bash
./bin/pchat -port 9001 -registry 127.0.0.1:8888 -username Alice
```

**方式 2：交互式输入**
```bash
./bin/pchat -port 9001 -registry 127.0.0.1:8888
```
程序会提示：
```
请输入用户名（直接回车使用默认名称）: 
```
输入用户名后按回车，或直接回车使用默认名称（节点ID的短格式）。

**参数说明：**
- `-port`: 监听端口（可选，默认随机）
- `-registry`: 注册服务器地址（必需，格式：127.0.0.1:8888）
- `-username`: 用户名（可选，不提供时会提示输入）
- `-ui`: 是否使用UI界面（可选，默认false，设置为true启用UI模式）
- `-peer`: 要连接的peer地址（可选，格式：/ip4/127.0.0.1/tcp/端口/p2p/peerID）

### 步骤 3: 启动第二个客户端

在另一个终端窗口中运行：

```bash
./bin/pchat -port 9002 -registry 127.0.0.1:8888 -username Bob
```

### 步骤 4: 查询在线用户

在任意客户端输入：

```bash
/list
# 或
/users
```

会显示所有在线用户列表。

### 步骤 5: 呼叫用户并连接

使用 `/call` 命令连接其他用户：

```bash
/call Alice
# 或
/call <节点ID>
```

### 步骤 6: 开始聊天

连接成功后，你可以：

1. **在任意一个终端输入消息**，按回车发送
2. **另一个终端会收到并显示解密后的消息**
3. **发送文件**：使用 `/sendfile <文件路径>` 或 `/file <文件路径>` 命令
4. **查询在线用户**：使用 `/list` 或 `/users` 命令
5. **呼叫用户**：使用 `/call <用户名>` 命令
6. **输入 `/quit` 或 `/exit` 退出程序**
7. **按 `Ctrl+C` 优雅关闭程序**
8. **使用 `/query <用户名>` 查询用户详细信息**

## 📋 可用命令

### 基本命令
- `/help` 或 `/h` - 显示帮助信息
- `/quit` 或 `/exit` - 退出程序
- `/refresh` 或 `/reload` - 刷新界面（仅UI模式）

### 用户管理命令
- `/list` 或 `/users` 或 `/l` - 查询在线用户列表（DHT模式或注册服务器模式）
- `/call <用户名或节点ID>` 或 `/c <用户名或节点ID>` - 呼叫并连接用户
- `/hangup` 或 `/disconnect` 或 `/d` - 挂断所有连接
- `/hangup <用户名或节点ID>` - 挂断指定用户连接
- `/query <用户名或节点ID>` 或 `/q <用户名或节点ID>` - 查询用户详细信息

### 文件传输命令
- `/sendfile <文件路径>` 或 `/file <文件路径>` 或 `/s <文件路径>` 或 `/f <文件路径>` - 发送文件

### 娱乐命令
- `/rps` 或 `/r` - 发起石头剪刀布游戏

### 命令简写
支持以下命令的首字母简写：
- `/c` = `/call`
- `/l` = `/list`
- `/s` = `/sendfile`
- `/f` = `/file`
- `/q` = `/query`
- `/r` = `/rps`
- `/d` = `/disconnect`
- `/h` = `/help`

## 🌐 DHT 去中心化发现模式

### 特点

- ✅ **完全去中心化**：无需中央注册服务器
- ✅ **自动发现**：自动发现网络中的其他用户
- ✅ **分布式存储**：用户信息存储在 DHT 网络中
- ✅ **自动广播**：定期广播自己的信息（每30秒）
- ✅ **本地缓存**：本地缓存发现的用户信息

### 工作原理

1. **DHT 网络**：使用 Kademlia DHT 算法构建分布式哈希表
2. **用户注册**：每个用户将自己的信息存储到 DHT 中
3. **用户发现**：通过 DHT 查找其他用户的信息
4. **自动更新**：定期更新自己的信息，保持在线状态

### 使用建议

- **首次使用**：建议先连接到一个已知节点以加入 DHT 网络
- **网络发现**：DHT 需要一些时间来发现网络中的节点
- **连接节点**：连接到更多节点可以提高发现效率

### DHT 模式 vs 注册服务器模式

| 特性 | DHT 模式 | 注册服务器模式 |
|------|---------|--------------|
| 需要服务器 | ❌ 不需要 | ✅ 需要 |
| 去中心化 | ✅ 完全去中心化 | ❌ 中心化 |
| 发现速度 | 较慢（需要DHT遍历） | 快速（直接查询） |
| 扩展性 | ✅ 优秀 | ⚠️ 受服务器限制 |
| 单点故障 | ✅ 无单点故障 | ❌ 服务器故障影响所有用户 |

### 使用示例

**注册服务器:**
```
🚀 启动注册服务器，端口: 8888
✅ 注册服务器已启动，监听端口 8888
```

**客户端 1 (Alice):**
```
✅ P2P 聊天节点已启动
📍 节点 ID: 12D3KooW...
📍 监听地址:
   /ip4/127.0.0.1/tcp/9001/p2p/12D3KooW...
✅ 已注册到服务器: 127.0.0.1:8888 (用户名: Alice)

> /list
📋 在线用户列表 (2 人):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 用户名: Alice
   节点ID: 12D3KooW...
   最后活跃: 5秒前
   地址: /ip4/127.0.0.1/tcp/9001/p2p/12D3KooW...

2. 用户名: Bob
   节点ID: 12D3KooW...
   最后活跃: 3秒前
   地址: /ip4/127.0.0.1/tcp/9002/p2p/12D3KooW...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

> /call Bob
🔍 正在查找用户: Bob
✅ 找到用户: Bob (节点ID: 12D3KooW...)
🔗 尝试连接: /ip4/127.0.0.1/tcp/9002/p2p/12D3KooW...
✅ 已连接到 12D3KooW...
✅ 已与 Bob (12D3KooW...) 交换公钥，可以开始聊天了！

> Hello Bob!
📤 已发送加密消息给 12D3KooW...
```

**客户端 2 (Bob):**
```
✅ P2P 聊天节点已启动
📍 节点 ID: 12D3KooW...
✅ 已注册到服务器: 127.0.0.1:8888 (用户名: Bob)

📨 收到来自 12D3KooW... 的消息:
💬 消息内容: Hello Bob!
✅ 消息已验证（签名有效，未检测到重放攻击）

> 
```

## 🎯 注册服务器（守护进程）

注册服务器用于管理在线用户，提供用户发现和连接服务。

### 功能

- 📝 **用户注册**：客户端可以注册到服务器
- 💓 **心跳机制**：客户端定期发送心跳保持在线状态
- 📋 **用户列表**：查询所有在线用户
- 🔍 **用户查找**：根据用户名或节点ID查找用户
- 🧹 **自动清理**：自动清理过期的离线用户

### 启动方式

```bash
./bin/registryd
```

默认监听端口：`8888`

### 配置

- `-port`: 指定监听端口（默认 8888）
- 心跳超时：30秒（超过60秒未收到心跳的用户会被移除）

## 功能特性

- ✅ P2P 直接连接（无需中央服务器）
- ✅ 端到端加密（AES + RSA）
- ✅ 自动公钥交换
- ✅ 实时消息收发
- ✅ 安全文件传输
- ✅ 用户注册和发现
- ✅ 在线用户查询
- ✅ 一键呼叫连接
- ✅ 支持多 peer 连接

## 📁 文件传输功能

### 发送文件

使用以下命令发送文件：

```bash
/sendfile <文件路径>
# 或
/file <文件路径>
```

**示例：**
```bash
> /sendfile /path/to/document.pdf
📁 准备发送文件: document.pdf (2.5 MB, 40 块)
   进度: 100.0% (40/40)
✅ 文件已发送给 12D3KooW...
```

### 接收文件

接收到的文件会自动保存到 `received_files/` 目录，文件名格式为：
```
received_files/YYYYMMDD_HHMMSS_原文件名
```

**接收示例：**
```
📁 收到来自 12D3KooW... 的文件传输请求
   文件名: document.pdf
   文件大小: 2.50 MB
   分块数量: 40
   接收进度: 40/40
✅ 文件已保存到: received_files/20240101_120000_document.pdf
✅ 文件已验证（签名和哈希都有效）
```

### 文件传输安全特性

- 🔒 **端到端加密**：文件内容使用 AES-256 加密，密钥使用 RSA-2048 加密
- ✍️ **数字签名**：文件头部和每个分块都经过数字签名验证
- 🔐 **完整性校验**：使用 SHA-256 哈希验证文件完整性
- 📦 **分块传输**：大文件自动分块传输（每块 64KB）
- ⏱️ **超时保护**：传输过程有超时保护机制

### 文件传输限制

- 最大文件大小：100 MB
- 分块大小：64 KB
- 传输超时：5 分钟

### 注意事项

- 确保有足够的磁盘空间接收文件
- 大文件传输可能需要一些时间，请耐心等待
- 文件会自动保存到 `received_files/` 目录
- 如果文件已存在，会添加时间戳前缀避免覆盖

## 🔒 安全特性

### 1. **端到端加密**
- 使用 AES-256 对称加密保护消息内容
- 使用 RSA-2048 非对称加密保护 AES 密钥
- 只有接收方可以解密消息

### 2. **数字签名**
- 每条消息都使用发送方的私钥进行数字签名
- 接收方使用发送方的公钥验证签名
- 确保消息来源的真实性和完整性

### 3. **防重放攻击**
- 每条消息包含唯一的随机数（nonce）
- 系统记录所有已使用的 nonce
- 检测并拒绝重复的消息（重放攻击）

### 4. **时间戳验证**
- 每条消息包含时间戳
- 自动拒绝超过 5 分钟的消息
- 防止过期消息被利用

### 5. **消息完整性保护**
- 数字签名确保消息未被篡改
- 如果消息被修改，签名验证会失败
- 系统会显示警告信息

### 安全消息流程

1. **发送方**：
   - 生成随机 nonce 和时间戳
   - 使用接收方公钥加密消息（AES + RSA）
   - 使用发送方私钥对消息进行数字签名
   - 发送包含加密数据、签名、时间戳和 nonce 的安全消息

2. **接收方**：
   - 验证消息时间戳（不超过 5 分钟）
   - 检查 nonce 是否已被使用（防重放）
   - 使用接收方私钥解密消息
   - 使用发送方公钥验证数字签名
   - 显示验证结果

### 安全提示

- ✅ **已验证消息**：签名有效，未检测到重放攻击
- ⚠️ **警告消息**：签名验证失败或检测到异常

## 🛑 优雅关闭机制

程序实现了完整的优雅关闭机制，确保资源正确清理：

### 关闭方式

1. **命令行退出**：输入 `/quit` 或 `/exit`
2. **信号退出**：按 `Ctrl+C` (SIGINT) 或发送 SIGTERM 信号

### 关闭流程

当收到关闭信号时，程序会：

1. ✅ **停止接收新消息**：不再处理新的输入和连接
2. ✅ **关闭所有连接**：优雅关闭所有活跃的 P2P 连接
3. ✅ **等待任务完成**：等待正在处理的消息完成（最多 5 秒）
4. ✅ **清理资源**：
   - 清理所有 nonce 记录（防重放攻击）
   - 清理公钥缓存
   - 关闭所有网络流
5. ✅ **安全退出**：确保所有资源都已释放

### 关闭示例

```
> /quit
👋 正在退出...

🛑 聊天已结束，开始优雅关闭...
📡 正在关闭所有连接...
   发现 1 个活跃连接
   关闭与 12D3KooW... 的连接...
✅ 所有任务已完成
🧹 正在清理资源...
   清理了 5 个 nonce 记录
   清理了 1 个公钥缓存
👋 程序已安全退出
```

### 特性

- ⏱️ **超时保护**：如果任务在 5 秒内未完成，会强制关闭
- 🔄 **上下文取消**：使用 context 机制通知所有 goroutine 停止
- 🧹 **资源清理**：自动清理所有内存和网络资源
- 📊 **状态显示**：显示关闭过程中的详细状态信息

## 注意事项

- 确保两个节点使用不同的端口
- 连接地址必须包含完整的 `/p2p/节点ID` 部分
- 消息使用接收方的公钥加密，只有接收方可以解密
- 系统会自动清理过期的 nonce 记录（每 1 分钟）
- 消息最大有效期为 5 分钟，过期消息会被拒绝
- 优雅关闭时，正在发送的消息可能会被中断
- 建议在发送完消息后再退出，以确保消息完整传输